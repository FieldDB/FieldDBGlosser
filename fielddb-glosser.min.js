/*! fielddb-glosser - v1.82.0 - 2013-11-29
* https://github.com/OpenSourceFieldlinguistics/FieldDB/issues/milestones?state=closed
* Copyright (c) 2013 FieldDB Contributors; Licensed Apache 2.0 */
!function(a){"use strict";var b={},c=c||{log:function(){}},d=d||{debugMode:!0,debug:function(a,b,d,e){this.debugMode&&(c.log(a),b&&c.log(b),d&&c.log(d),e&&c.log(e))},makeCORSRequest:function(a){d.debugMode=!1,a.method||(a.method=a.type||"GET"),a.url||d.bug("There was an error. Please report this."),a.data||(a.data=""),a.dataToSend=JSON.stringify(a.data).replace(/,/g,"&").replace(/:/g,"=").replace(/"/g,"").replace(/[}{]/g,""),"GET"===a.method&&a.data&&(a.url=a.url+"?"+a.dataToSend);var b=function(a,b){var c=new XMLHttpRequest;return"withCredentials"in c?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c},c=b(a.method,a.url);return c?(c.setRequestHeader("Content-type","application/json"),c.withCredentials=!0,c.onload=function(b,e,f){var g=c.responseText;d.debugMode&&d.debug("Response from CORS request to "+a.url+": "+g),"function"==typeof a.success&&(g?a.success(JSON.parse(g)):(d.bug("There was no content in the server's response text. Please report this."),a.error(b,e,f))),d.debugMode=!1},c.onerror=function(b,c,e){d.debugMode&&d.debug(b,c,e),d.bug("There was an error making the CORS request to "+a.url+" from "+window.location.href+" the app will not function normally. Please report this."),"function"==typeof a.error&&a.error(b,c,e)},"POST"===a.method?c.send(JSON.stringify(a.data)):c.send(),void 0):(d.bug("CORS not supported, your browser is unable to contact the database."),void 0)}};b.currentCorpusName="",b.downloadPrecedenceRules=function(a,e,f){if(!e||"default"===e){if(!window.app)throw"Glosser cant be guessed, there is no app so the URL must be defined.";var g=window.app.get("corpus").get("couchConnection"),h=d.getCouchUrl(g);e=h+"/_design/pages/_view/precedence_rules?group=true"}d.makeCORSRequest({type:"GET",url:e,success:function(c){localStorage.setItem(a+"precendenceRules",JSON.stringify(c.rows));var d=_.chain(c.rows).groupBy(function(a){return a.key.x+"-"+a.key.y}).value();localStorage.setItem(a+"reducedRules",JSON.stringify(d)),b.currentCorpusName=a,"function"==typeof f&&f()},error:function(a){c.log("error getting precedence rules:",a)},dataType:""})},b.morphemefinder=function(a,b,c){if(!a)return"";if(c)return a;if(!b){if(!window.app||!window.app.get("corpus"))throw"Glosser can't be guessed, there is no app so the URL must be defined.";b=window.app.get("corpus").get("couchConnection").pouchname}var e="",f=localStorage.getItem(b+"reducedRules"),g=[];if(f){f=JSON.parse(f);var h=a.trim().split(/ +/);for(var i in h){h[i]="@"+h[i]+"@";var j=[];for(var k in f)h[i].indexOf(k.replace(/-/,""))>=0&&j.push({r:f[k]});var l=[];l.push("@");for(var m=0;10>m&&void 0!==l[m];m++)for(var n in j)if(l[m]===j[n].r[0].key.x){if(l[m+1]){l.pop();break}l[m+1]=j[n].r[0].key.y}var o=[];if("@"!==l[l.length-1]||1===l.length){o.push("@");for(var p=0;10>p&&void 0!==o[p];p++)for(var q in j)if(o[p]===j[q].r[0].key.y){if(o[p+1]){o.pop();break}o[p+1]=j[q].r[0].key.x}}var r=[];r=l.concat(o.reverse());for(var s in r)r[s]="("+r[s]+")";var t=new RegExp(r.join("(.*)"),"");e=h[i].replace(t,"$1-$2-$3-$4-$5-$6-$7-$8-$9").replace(/\$[0-9]/g,"").replace(/@/g,"").replace(/--+/g,"-").replace(/^-/,"").replace(/-$/,""),d.debugMode&&d.debug("Potential parse of "+h[i].replace(/@/g,"")+" is "+e),g.push(e)}}return g.join(" ")},b.glossFinder=function(a,b,e){if(!a)return"";if(e){var f=a.trim().replace(/[^ -]+/g,"?");return f}if(!b){if(!window.app||!window.app.get("corpus"))throw"Glosser can't be guessed, there is no app so the URL must be defined.";b=window.app.get("corpus").get("couchConnection").pouchname}var g=localStorage.getItem(b+"lexiconResults");if(!g)return"";g=JSON.parse(g);var h=[],i=a.split(/ +/);for(var j in i){var k=i[j].split("-"),l=[];for(var m in k){var n=[],o=g[k[m]];o&&n.push(o),o=g[k[m].toLowerCase()],o&&n.push(o);var p="?";if(n.length>0){c.log("Glosses which match: ",n);try{p=n[0][0].gloss}catch(q){d.debug(n)}}l.push(p)}h.push(l.join("-"))}return h.join(" ")},b.guessUtteranceFromMorphemes=function(a){return!a.utterance&&a.morphemes&&(a.utterance=a.morphemes.replace(/[-.]/g,"")),a},b.guessMorphemesFromUtterance=function(a,c){return a.morphemes?a:(a.morphemes=b.morphemefinder(a.utterance,a.pouchname,c),a.gloss||(a.gloss=b.glossFinder(a.morphemes,a.pouchname,c)),a)},b.guessGlossFromMorphemes=function(a,c){return a.gloss?a:(a.gloss=a.morphemes?b.glossFinder(a.morphemes,a.pouchname,c):b.glossFinder(a.utterance,a.pouchname,c),a)},b.generateForceDirectedRulesJsonForD3=function(a,c){if(c||(c=b.currentCorpusName),a||(a=localStorage.getItem(c+"precendenceRules"),a&&(a=JSON.parse(a))),a){var d=[],e=[];for(var f in a){"@"===a[f].key.x&&(a[f].key.x="#_"),"@"===a[f].key.y&&(a[f].key.y="_#");var g=e.indexOf(a[f].key.x);0>g&&(e.push(a[f].key.x),g=e.length-1);var h=e.indexOf(a[f].key.y);0>h&&(e.push(a[f].key.y),h=e.length-1),-1===a[f].key.y.indexOf("@")&&d.push({source:g,target:h,value:1})}var i=[];for(var j in e)i.push({name:e[j],length:e[j].length});var k={};return k.links=d,k.nodes=i,b.rulesGraph=k,k}},b.saveAndInterConnectInApp=function(a){"function"==typeof a&&a()},b.visualizeMorphemesAsForceDirectedGraph=function(a,c,d){if(!d)throw"Must provide corpus name to be able to visualize morphemes";if(b.currentCorpusName=d,a||(a=b.rulesGraph,a?0===a.links.length&&(a=b.generateForceDirectedRulesJsonForD3()):a=b.generateForceDirectedRulesJsonForD3()),a&&0!==b.rulesGraph.links.length){var e=a,f=800,g=300,h=d3.scale.linear().range(["darkblue","darkred"]).domain([1,8]),i=(d3.scale.linear().range([0,f]),d3.scale.linear().range([0,g-40]),d3.layout.force().charge(-120).linkStrength(.2).linkDistance(30).size([f,g])),j=d3.select(c).append("svg").attr("width",f).attr("title","Morphology Visualization for "+d).attr("height",g),k="Click to search morphemes in your corpus";a.nodes.length<3&&(k="Your morpheme visualizer will appear here after you have synced.");var l=(j.append("text").attr("class","vis-title").attr("dy","1em").attr("dx","1em").style("fill","#cccccc").text(k),null);i.nodes(e.nodes).links(e.links).start();var m=j.selectAll("line.link").data(e.links).enter().append("line").attr("class","link").style("stroke-width",function(a){return Math.sqrt(a.value)}),n=j.selectAll("circle.node").data(e.nodes).enter().append("circle").attr("class","node").attr("r",5).style("fill",function(a){return h(a.length)}).on("mouseover",function(a){l=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","visible").style("color","#fff").text(a.name)}).on("mouseout",function(){l.style("visibility","hidden")}).on("click",function(a){if(window.app&&window.app.router){var b="corpus/"+d+"/search/morphemes:"+a.name;window.app.router.navigate(b,{trigger:!0})}}).call(i.drag);n.append("title").text(function(a){return a.name}),i.on("tick",function(){m.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),n.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}},b.init=function(){return"init"},a.Glosser=b}("object"==typeof exports&&exports||this);