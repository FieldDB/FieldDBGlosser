/*! fielddb-glosser - v1.82.0 - 2013-11-28
* https://github.com/OpenSourceFieldlinguistics/FieldDB/issues/milestones?state=closed
* Copyright (c) 2013 FieldDB Contributors; Licensed Apache 2.0 */
!function(a){"use strict";var b={},c=c||{log:function(){}},d=d||{debugMode:!0,debug:function(a,b,d,e){this.debugMode&&(c.log(a),b&&c.log(b),d&&c.log(d),e&&c.log(e))},makeCORSRequest:function(a){d.debugMode=!1,a.method||(a.method=a.type||"GET"),a.url||d.bug("There was an error. Please report this."),a.data||(a.data=""),a.dataToSend=JSON.stringify(a.data).replace(/,/g,"&").replace(/:/g,"=").replace(/"/g,"").replace(/[}{]/g,""),"GET"===a.method&&a.data&&(a.url=a.url+"?"+a.dataToSend);var b=function(a,b){var c=new XMLHttpRequest;return"withCredentials"in c?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c},c=b(a.method,a.url);return c?(c.setRequestHeader("Content-type","application/json"),c.withCredentials=!0,c.onload=function(b,e,f){var g=c.responseText;d.debugMode&&d.debug("Response from CORS request to "+a.url+": "+g),"function"==typeof a.success&&(g?a.success(JSON.parse(g)):(d.bug("There was no content in the server's response text. Please report this."),a.error(b,e,f))),d.debugMode=!1},c.onerror=function(b,c,e){d.debugMode&&d.debug(b,c,e),d.bug("There was an error making the CORS request to "+a.url+" from "+window.location.href+" the app will not function normally. Please report this."),"function"==typeof a.error&&a.error(b,c,e)},"POST"===a.method?c.send(JSON.stringify(a.data)):c.send(),void 0):(d.bug("CORS not supported, your browser is unable to contact the database."),void 0)}};b.currentCorpusName="",b.downloadPrecedenceRules=function(a,e,f){if(!e||"default"===e){if(!window.app)throw"Glosser cant be guessed, there is no app so the URL must be defined.";var g=window.app.get("corpus").get("couchConnection"),h=d.getCouchUrl(g);e=h+"/_design/pages/_view/precedence_rules?group=true"}d.makeCORSRequest({type:"GET",url:e,success:function(c){localStorage.setItem(a+"precendenceRules",JSON.stringify(c.rows));var d=_.chain(c.rows).groupBy(function(a){return a.key.x+"-"+a.key.y}).value();localStorage.setItem(a+"reducedRules",JSON.stringify(d)),b.currentCorpusName=a,"function"==typeof f&&f()},error:function(a){c.log("error getting precedence rules:",a)},dataType:""})},b.morphemefinder=function(a,b){if(!b){if(!window.app||!window.app.get("corpus"))throw"Glosser can't be guessed, there is no app so the URL must be defined.";b=window.app.get("corpus").get("couchConnection").pouchname}var c="",e=localStorage.getItem(b+"reducedRules"),f=[];if(e){e=JSON.parse(e);var g=a.trim().split(/ +/);for(var h in g){g[h]="@"+g[h]+"@";var i=[];for(var j in e)g[h].indexOf(j.replace(/-/,""))>=0&&i.push({r:e[j]});var k=[];k.push("@");for(var l=0;10>l&&void 0!==k[l];l++)for(var m in i)if(k[l]===i[m].r[0].key.x){if(k[l+1]){k.pop();break}k[l+1]=i[m].r[0].key.y}var n=[];if("@"!==k[k.length-1]||1===k.length){n.push("@");for(var o=0;10>o&&void 0!==n[o];o++)for(var p in i)if(n[o]===i[p].r[0].key.y){if(n[o+1]){n.pop();break}n[o+1]=i[p].r[0].key.x}}var q=[];q=k.concat(n.reverse());for(var r in q)q[r]="("+q[r]+")";var s=new RegExp(q.join("(.*)"),"");c=g[h].replace(s,"$1-$2-$3-$4-$5-$6-$7-$8-$9").replace(/\$[0-9]/g,"").replace(/@/g,"").replace(/--+/g,"-").replace(/^-/,"").replace(/-$/,""),d.debugMode&&d.debug("Potential parse of "+g[h].replace(/@/g,"")+" is "+c),f.push(c)}}return f.join(" ")},b.glossFinder=function(a,b){if(!a)return"";if(!b){if(!window.app||!window.app.get("corpus"))throw"Glosser can't be guessed, there is no app so the URL must be defined.";b=window.app.get("corpus").get("couchConnection").pouchname}var e=localStorage.getItem(b+"lexiconResults");if(!e)return"";e=JSON.parse(e);var f=[],g=a.split(/ +/);for(var h in g){var i=g[h].split("-"),j=[];for(var k in i){var l=[],m=e[i[k]];m&&l.push(m),m=e[i[k].toLowerCase()],m&&l.push(m);var n="?";if(l.length>0){c.log("Glosses which match: ",l);try{n=l[0][0].gloss}catch(o){d.debug(l)}}j.push(n)}f.push(j.join("-"))}return f.join(" ")},b.generateForceDirectedRulesJsonForD3=function(a,c){if(c||(c=b.currentCorpusName),a||(a=localStorage.getItem(c+"precendenceRules"),a&&(a=JSON.parse(a))),a){var d=[],e=[];for(var f in a){"@"===a[f].key.x&&(a[f].key.x="#_"),"@"===a[f].key.y&&(a[f].key.y="_#");var g=e.indexOf(a[f].key.x);0>g&&(e.push(a[f].key.x),g=e.length-1);var h=e.indexOf(a[f].key.y);0>h&&(e.push(a[f].key.y),h=e.length-1),-1===a[f].key.y.indexOf("@")&&d.push({source:g,target:h,value:1})}var i=[];for(var j in e)i.push({name:e[j],length:e[j].length});var k={};return k.links=d,k.nodes=i,b.rulesGraph=k,k}},b.saveAndInterConnectInApp=function(a){"function"==typeof a&&a()},b.visualizeMorphemesAsForceDirectedGraph=function(a,c,d){if(!d)throw"Must provide corpus name to be able to visualize morphemes";if(b.currentCorpusName=d,a||(a=b.rulesGraph,a?0===a.links.length&&(a=b.generateForceDirectedRulesJsonForD3()):a=b.generateForceDirectedRulesJsonForD3()),a&&0!==b.rulesGraph.links.length){var e=a,f=800,g=300,h=d3.scale.linear().range(["darkblue","darkred"]).domain([1,8]),i=(d3.scale.linear().range([0,f]),d3.scale.linear().range([0,g-40]),d3.layout.force().charge(-120).linkStrength(.2).linkDistance(30).size([f,g])),j=d3.select(c).append("svg").attr("width",f).attr("title","Morphology Visualization for "+d).attr("height",g),k="Click to search morphemes in your corpus";a.nodes.length<3&&(k="Your morpheme visualizer will appear here after you have synced.");var l=(j.append("text").attr("class","vis-title").attr("dy","1em").attr("dx","1em").style("fill","#cccccc").text(k),null);i.nodes(e.nodes).links(e.links).start();var m=j.selectAll("line.link").data(e.links).enter().append("line").attr("class","link").style("stroke-width",function(a){return Math.sqrt(a.value)}),n=j.selectAll("circle.node").data(e.nodes).enter().append("circle").attr("class","node").attr("r",5).style("fill",function(a){return h(a.length)}).on("mouseover",function(a){l=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","visible").style("color","#fff").text(a.name)}).on("mouseout",function(){l.style("visibility","hidden")}).on("click",function(a){if(window.app&&window.app.router){var b="corpus/"+d+"/search/morphemes:"+a.name;window.app.router.navigate(b,{trigger:!0})}}).call(i.drag);n.append("title").text(function(a){return a.name}),i.on("tick",function(){m.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),n.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}},b.init=function(){return"init"},a.Glosser=b}("object"==typeof exports&&exports||this);